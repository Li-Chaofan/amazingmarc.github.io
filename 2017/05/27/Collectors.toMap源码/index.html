<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Java, Meituan" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="在使用Stream时，经常会有将一个list转换为一个map的场景，这时会用到Collectors.toMap方法，这篇文章中我们详细介绍一下toMap方法以及使用该方法的几个注意点。最后我们自己实现了Collectors接口来定义了自己的toMapCollector。
注意：最好先看一下Collector接口 这篇文章才能更好理解这篇文章。">
<meta property="og:type" content="article">
<meta property="og:title" content="Collectors.toMap解析">
<meta property="og:url" content="http://yoursite.com/2017/05/27/Collectors.toMap源码/index.html">
<meta property="og:site_name" content="marc's home">
<meta property="og:description" content="在使用Stream时，经常会有将一个list转换为一个map的场景，这时会用到Collectors.toMap方法，这篇文章中我们详细介绍一下toMap方法以及使用该方法的几个注意点。最后我们自己实现了Collectors接口来定义了自己的toMapCollector。
注意：最好先看一下Collector接口 这篇文章才能更好理解这篇文章。">
<meta property="og:updated_time" content="2018-05-27T11:32:57.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Collectors.toMap解析">
<meta name="twitter:description" content="在使用Stream时，经常会有将一个list转换为一个map的场景，这时会用到Collectors.toMap方法，这篇文章中我们详细介绍一下toMap方法以及使用该方法的几个注意点。最后我们自己实现了Collectors接口来定义了自己的toMapCollector。
注意：最好先看一下Collector接口 这篇文章才能更好理解这篇文章。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/05/27/Collectors.toMap源码/"/>





  <title> Collectors.toMap解析 | marc's home </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">marc's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/27/Collectors.toMap源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="marc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/lufei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="marc's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Collectors.toMap解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-27T19:19:00+08:00">
                2017-05-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java8/" itemprop="url" rel="index">
                    <span itemprop="name">java8</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在使用Stream时，经常会有将一个list转换为一个map的场景，这时会用到Collectors.toMap方法，这篇文章中我们详细介绍一下toMap方法以及使用该方法的几个注意点。最后我们自己实现了Collectors接口来定义了自己的toMapCollector。</p>
<p>注意：最好先看一下<a href="/2017/05/27/Collector接口/" title="Collector接口">Collector接口</a> 这篇文章才能更好理解这篇文章。</p>
<a id="more"></a>
<p>首先我们定义如下类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在有一个包含Member的list memebers，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">List&lt;Member&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</div><div class="line">Member member1 = <span class="keyword">new</span> Member();</div><div class="line">member1.setName(<span class="string">"lichaofan"</span>);</div><div class="line">member1.setId(<span class="number">1</span>);</div><div class="line">member1.setType(<span class="number">1</span>);</div><div class="line">members.add(member1);</div><div class="line"></div><div class="line">Member member2 = <span class="keyword">new</span> Member();</div><div class="line">member2.setName(<span class="string">"wanghongli"</span>);</div><div class="line">member2.setId(<span class="number">2</span>);</div><div class="line">member2.setType(<span class="number">2</span>);</div><div class="line">members.add(member2);</div></pre></td></tr></table></figure>
<h1 id="1-Collectors-toMap源码"><a href="#1-Collectors-toMap源码" class="headerlink" title="1 Collectors.toMap源码"></a>1 Collectors.toMap源码</h1><p>该接口主要是构造一个Collectors接口的实例交给Stream.collect（Collector collector）方法</p>
<p>我们使用如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Map&lt;Long, Member&gt; map = members.stream().collect(Collectors.toMap(Member::getId, Function.identity()));</div></pre></td></tr></table></figure></p>
<p>该方法在现有的memebers列表中 完全可行，执行没有任何问题。 我们来看一下Collectors.toMap这个实现，（只留下我们关注的注释）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</div><div class="line"> * 返回一个Collector实例，该实例可以将流中的元素规约成一个Map，Map中的key和value</div><div class="line"> * 是通过对输入的元素应用 提供的映射函数来构造的。</div><div class="line"> * Returns a &#123;<span class="doctag">@code</span> Collector&#125; that accumulates elements into a</div><div class="line"> * &#123;<span class="doctag">@code</span> Map&#125; whose keys and values are the result of applying the provided</div><div class="line"> * mapping functions to the input elements.</div><div class="line"> *</div><div class="line"> * 如果 包含相同的key（通过key的equals方法判断）那么会抛出异常，如果key中可能会有重复的情况，那么</div><div class="line"> * 可以使用toMap(Function, Function, BinaryOperator)这个方法</div><div class="line"> * &lt;p&gt;If the mapped keys contains duplicates (according to</div><div class="line"> * &#123;<span class="doctag">@link</span> Object#equals(Object)&#125;), an &#123;<span class="doctag">@code</span> IllegalStateException&#125; is</div><div class="line"> * thrown when the collection operation is performed.  If the mapped keys</div><div class="line"> * may have duplicates, use &#123;<span class="doctag">@link</span> #toMap(Function, Function, BinaryOperator)&#125;</div><div class="line"> * instead.</div><div class="line"> *</div><div class="line"> * 下面是一些例子</div><div class="line"> * <span class="doctag">@apiNote</span></div><div class="line"> * It is common for either the key or the value to be the input elements.</div><div class="line"> * In this case, the utility method</div><div class="line"> * &#123;<span class="doctag">@link</span> java.util.function.Function#identity()&#125; may be helpful.</div><div class="line"> * For example, the following produces a &#123;<span class="doctag">@code</span> Map&#125; mapping</div><div class="line"> * students to their grade point average:</div><div class="line"> * &lt;pre&gt;&#123;<span class="doctag">@code</span></div><div class="line"> *     Map&lt;Student, Double&gt; studentToGPA</div><div class="line"> *         students.stream().collect(toMap(Functions.identity(),</div><div class="line"> *                                         student -&gt; computeGPA(student)));</div><div class="line"> * &#125;&lt;/pre&gt;</div><div class="line"> * And the following produces a &#123;<span class="doctag">@code</span> Map&#125; mapping a unique identifier to</div><div class="line"> * students:</div><div class="line"> * &lt;pre&gt;&#123;<span class="doctag">@code</span></div><div class="line"> *     Map&lt;String, Student&gt; studentIdToStudent</div><div class="line"> *         students.stream().collect(toMap(Student::getId,</div><div class="line"> *                                         Functions.identity());</div><div class="line"> * &#125;&lt;/pre&gt;</div><div class="line"> *</div><div class="line"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, K, U&gt;</div><div class="line">Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</div><div class="line">                                Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper) &#123;</div><div class="line">    <span class="keyword">return</span> toMap(keyMapper, valueMapper, throwingMerger(), HashMap::<span class="keyword">new</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中一个比较关键的一点是，如果key中出现重复，那么会抛出异常，这种情况一会儿我们会详细说明。现在先看一下方法中调用的 另外一个toMap方法(同样，我们删掉了一些注释)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</div><div class="line"> * Returns a &#123;<span class="doctag">@code</span> Collector&#125; that accumulates elements into a</div><div class="line"> * &#123;<span class="doctag">@code</span> Map&#125; whose keys and values are the result of applying the provided</div><div class="line"> * mapping functions to the input elements.</div><div class="line"> *</div><div class="line"> * 如果 key中存在重复的key,那么会将这些重复的key对应的value应用 merging function得到结果。</div><div class="line"> * 这个Map是由提供的supplier函数提供的。</div><div class="line"> * &lt;p&gt;If the mapped</div><div class="line"> * keys contains duplicates (according to &#123;<span class="doctag">@link</span> Object#equals(Object)&#125;),</div><div class="line"> * the value mapping function is applied to each equal element, and the</div><div class="line"> * results are merged using the provided merging function.  The &#123;<span class="doctag">@code</span> Map&#125;</div><div class="line"> * is created by a provided supplier function.</div><div class="line"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, K, U, M extends Map&lt;K, U&gt;&gt;</div><div class="line">Collector&lt;T, ?, M&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</div><div class="line">                            Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper,</div><div class="line">                            BinaryOperator&lt;U&gt; mergeFunction,</div><div class="line">                            Supplier&lt;M&gt; mapSupplier) &#123;</div><div class="line">    BiConsumer&lt;M, T&gt; accumulator</div><div class="line">            = (map, element) -&gt; map.merge(keyMapper.apply(element),</div><div class="line">                                          valueMapper.apply(element), mergeFunction);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CollectorImpl&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到，这个方法（四个参数的toMap方法）对于重复key，是通过参数中的mergeFunction对相同key对应的value进行处理。而上一个toMap（两个参数的toMap方法）方法传入的是一个throwingMerger()方法，该方法会抛出Duplicate key异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">BinaryOperator&lt;T&gt; <span class="title">throwingMerger</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (u,v) -&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Duplicate key %s"</span>, u)); &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们继续看四个参数的toMap方法中的实现，首先我们先看return语句，该方法返回的是一个CollectorImpl类，该类是一个Collector接口的实现，该类定义如下（在Collectors接口中进行了定义）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectorImpl</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Collector</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> Supplier&lt;A&gt; supplier;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> BiConsumer&lt;A, T&gt; accumulator;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> BinaryOperator&lt;A&gt; combiner;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;A, R&gt; finisher;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Characteristics&gt; characteristics;</div><div class="line"></div><div class="line">     CollectorImpl(Supplier&lt;A&gt; supplier,</div><div class="line">                   BiConsumer&lt;A, T&gt; accumulator,</div><div class="line">                   BinaryOperator&lt;A&gt; combiner,</div><div class="line">                   Function&lt;A,R&gt; finisher,</div><div class="line">                   Set&lt;Characteristics&gt; characteristics) &#123;</div><div class="line">         <span class="keyword">this</span>.supplier = supplier;</div><div class="line">         <span class="keyword">this</span>.accumulator = accumulator;</div><div class="line">         <span class="keyword">this</span>.combiner = combiner;</div><div class="line">         <span class="keyword">this</span>.finisher = finisher;</div><div class="line">         <span class="keyword">this</span>.characteristics = characteristics;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     CollectorImpl(Supplier&lt;A&gt; supplier,</div><div class="line">                   BiConsumer&lt;A, T&gt; accumulator,</div><div class="line">                   BinaryOperator&lt;A&gt; combiner,</div><div class="line">                   Set&lt;Characteristics&gt; characteristics) &#123;</div><div class="line">         <span class="keyword">this</span>(supplier, accumulator, combiner, castingIdentity(), characteristics);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">//省去getter方法</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>可以看到其实就是指定Colector接口中相应的 supplier,accumulator,combiner,finisher,和characteristics （详细可看<a href="/2017/05/27/Collector接口/" title="Collector接口">Collector接口</a> ）;</p>
<p>对应到两个方法的toMap方法，构造的CollectorImpl参数如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">supplier = HashMap::<span class="keyword">new</span></div><div class="line"></div><div class="line"><span class="comment">//“累加器”，一会儿详细说</span></div><div class="line">accumulator = (map, element) -&gt; map.merge(keyMapper.apply(element),valueMapper.apply(element), mergeFunction);</div><div class="line"></div><div class="line"><span class="comment">//这里的mergeFunction就是上面说的throwingMerger方法</span></div><div class="line">combiner = mapMerger(mergeFunction)</div><div class="line"><span class="comment">//将第二个map中的key，value merge到m1中 </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;K, V, M extends Map&lt;K,V&gt;&gt;</div><div class="line">   <span class="function">BinaryOperator&lt;M&gt; <span class="title">mapMerger</span><span class="params">(BinaryOperator&lt;V&gt; mergeFunction)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (m1, m2) -&gt; &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;K,V&gt; e : m2.entrySet())</div><div class="line">                m1.merge(e.getKey(), e.getValue(), mergeFunction);</div><div class="line">            <span class="keyword">return</span> m1;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">characteristics = CH_ID (一个集合常量只包含 Collector.Characteristics.IDENTITY_FINISH)</div><div class="line"></div><div class="line">finisher = castingIdentity（）方法</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> &lt;I, R&gt; <span class="function">Function&lt;I, R&gt; <span class="title">castingIdentity</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> i -&gt; (R) i;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们重点看一下accumulator（accumulator是一个“累加器”）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BiConsumer&lt;M, T&gt; accumulator</div><div class="line">                = (map, element) -&gt; map.merge(keyMapper.apply(element),</div><div class="line">                                              valueMapper.apply(element), mergeFunction);</div></pre></td></tr></table></figure>
<p>对于流中的第n个元素元素element， 使用KeyMapper(Member::getId)获取key，使用valueMapper(Function.identity() 也就是 r -&gt; r)获取value，<br>然后连同 mergeFunction 使用map.merge（这个map已经包含了前n-1个元素）方法将这第n个元素包含进来完成“累加”。</p>
<p>那Map的merge方法是如何实现的呢？ 源码如下(该实现是java8中新增的使用default方法在Map接口中定义)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">default</span> V <span class="title">merge</span><span class="params">(K key, V value,</div><div class="line">            BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</div><div class="line">        Objects.requireNonNull(remappingFunction);</div><div class="line">        <span class="comment">//这个value不能为 null</span></div><div class="line">        Objects.requireNonNull(value);</div><div class="line">        <span class="comment">//首先通过key获取对应的value</span></div><div class="line">        V oldValue = get(key);</div><div class="line">        <span class="comment">//如果value为空，那么 newVlue=value, 如果不为null，那么对于oldVlue 和value应用remappingFunction 也就是mergeFunction 赋给newValue</span></div><div class="line">        V newValue = (oldValue == <span class="keyword">null</span>) ? value :</div><div class="line">                   remappingFunction.apply(oldValue, value);</div><div class="line">        <span class="keyword">if</span>(newValue == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//如果newVlue为null 那么remove key</span></div><div class="line">            remove(key);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        	<span class="comment">//newVlue不为null 那么put key,value</span></div><div class="line">            put(key, newValue);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> newValue;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个实现里有两个值得注意的点：</p>
<ol>
<li>merge方法的value不能为null（但是HashMap中的value是可以为null的）。</li>
<li>当key已经存在时，会通过remappingFunction 也就是mergeFunction 重新计算该key对应的value，这个函数以的参数是 oldVlue和新传进来的value.</li>
</ol>
<p>Ok, 到目前为止，我们看到Collectors中两个toMap方法，以及Collectors中如何构造Collector接口的实例。细心可以发现，对于两个参数的toMap方法，有以下两个点需要注意：</p>
<ol>
<li>当key有重复的时候会抛出 “Duplicate key” 异常。</li>
<li>因为“累加器”中使的是Map.merge方法，该方法的value不能为null。否则会抛出空指针异常。</li>
</ol>
<p>这两点也是新手使用java8中会经常犯得错误，接下来详细说明一下这两点。</p>
<h1 id="2-关于-“Duplicate-key”"><a href="#2-关于-“Duplicate-key”" class="headerlink" title="2 关于 “Duplicate key”"></a>2 关于 “Duplicate key”</h1><p>在原有members中再添加一个Member</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Member member3 = <span class="keyword">new</span> Member();</div><div class="line">member3.setName(<span class="string">"love"</span>);</div><div class="line">member3.setId(<span class="number">1</span>);</div><div class="line">member3.setType(<span class="number">3</span>);</div><div class="line">members.add(member3);</div><div class="line"></div><div class="line">Map&lt;Long, Member&gt; map = members.stream().collect(Collectors.toMap(Member::getId, Function.identity()));</div></pre></td></tr></table></figure>
<p>这时 memeber3和memeber1 拥有相同的id，也就是转换成Map的时候key会有重复，运行可以看到如下异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Duplicate key Member@<span class="number">7</span>cd84586</div><div class="line">	at java.util.stream.Collectors.lambda$throwingMerger$<span class="number">0</span>(Collectors.java:<span class="number">133</span>)</div><div class="line">	at java.util.HashMap.merge(HashMap.java:<span class="number">1254</span>)</div><div class="line">	at java.util.stream.Collectors.lambda$toMap$<span class="number">58</span>(Collectors.java:<span class="number">1320</span>)</div><div class="line">	at java.util.stream.ReduceOps$<span class="number">3</span>ReducingSink.accept(ReduceOps.java:<span class="number">169</span>)</div><div class="line">	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:<span class="number">1380</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:<span class="number">481</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:<span class="number">471</span>)</div><div class="line">	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:<span class="number">708</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:<span class="number">234</span>)</div><div class="line">	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:<span class="number">499</span>)</div><div class="line">	at test.main(test.java:<span class="number">55</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">147</span>)</div></pre></td></tr></table></figure>
<p>也就是我们上面分析的 “Duplicate key” 异常。</p>
<p>所以对于要转换的list中可能会出现重复key时，我们就不能使用两个参数的toMap方法，可以使用 Collectors三个参数的toMap方法，指定mergeFunction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//第三个参数即可自己指定mergeFunction</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, K, U&gt;</div><div class="line">  Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</div><div class="line">                                  Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper,</div><div class="line">                                  BinaryOperator&lt;U&gt; mergeFunction) &#123;</div><div class="line">      <span class="keyword">return</span> toMap(keyMapper, valueMapper, mergeFunction, HashMap::<span class="keyword">new</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看到 该方法也是调用了4个参数的toMap方法，当然也可以直接使用4个参数的toMap方法；</p>
<p>那么我们的对list的转换可以变成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//即 如果key可能存在重复，那我们始终用新的value进行替换</span></div><div class="line">Map&lt;Long, Member&gt; map = members.stream().collect(Collectors.toMap(Member::getId, Function.identity(), (oldValue, newValue) -&gt; newValue));</div></pre></td></tr></table></figure>
<h1 id="3-关于-value可能为null的情况"><a href="#3-关于-value可能为null的情况" class="headerlink" title="3 关于 value可能为null的情况"></a>3 关于 value可能为null的情况</h1><p>如果现在我们想通过members构造一个key为id, value为name的Map，并且members中添加一个如下元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Member member3 = <span class="keyword">new</span> Member();</div><div class="line"><span class="comment">//这里name是null</span></div><div class="line">member3.setName(<span class="keyword">null</span>);</div><div class="line">member3.setId(<span class="number">3</span>);</div><div class="line">member3.setType(<span class="number">3</span>);</div><div class="line">members.add(member3); </div><div class="line"><span class="comment">//当有重复key时，将value相加</span></div><div class="line">Map&lt;Long, String&gt; nameMap = members.stream().collect(Collectors.toMap(Member::getId, Member::getName, (oldValue, newValue) -&gt; oldValue + newValue));</div></pre></td></tr></table></figure>
<p>运行上面的程序会有如下报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">java.lang.NullPointerException</div><div class="line">	at java.util.HashMap.merge(HashMap.java:<span class="number">1225</span>)</div><div class="line">	at java.util.stream.Collectors.lambda$toMap$<span class="number">58</span>(Collectors.java:<span class="number">1320</span>)</div><div class="line">	at java.util.stream.ReduceOps$<span class="number">3</span>ReducingSink.accept(ReduceOps.java:<span class="number">169</span>)</div><div class="line">	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:<span class="number">1380</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:<span class="number">481</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:<span class="number">471</span>)</div><div class="line">	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:<span class="number">708</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:<span class="number">234</span>)</div><div class="line">	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:<span class="number">499</span>)</div><div class="line">	at test.main(test.java:<span class="number">33</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">147</span>)</div></pre></td></tr></table></figure>
<p>这就是之前我们分析的Map.merge方法中value不能为null造成的。</p>
<p>那么如何解决呢？有以下三种方法：</p>
<h2 id="传统的for循环或者forEach"><a href="#传统的for循环或者forEach" class="headerlink" title="传统的for循环或者forEach"></a>传统的for循环或者forEach</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Map&lt;Long, String&gt; nameMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">members.stream().forEach(member -&gt; nameMap.put(member.getId(), member.getName()));</div><div class="line"></div><div class="line"><span class="keyword">for</span> (Member member : members)&#123;</div><div class="line">    nameMap.put(member.getId(), member.getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用collector的重载方法，自定义supplier-accumulator-和combiner"><a href="#使用collector的重载方法，自定义supplier-accumulator-和combiner" class="headerlink" title="使用collector的重载方法，自定义supplier, accumulator,和combiner"></a>使用collector的重载方法，自定义supplier, accumulator,和combiner</h2><p>因为本身Collectors.toMap也是IDENTITY_FINISH的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//注意 toMap中accumulator使用的Map.merge方法，对于重复的key使用mergeFunction，而这里我们指定的accumulator是put方法。</span></div><div class="line">nameMap = members.stream().collect(HashMap::<span class="keyword">new</span>, (m, element) -&gt; m.put(element.getId(), element.getName()), HashMap::putAll);</div></pre></td></tr></table></figure>
<h2 id="自己实现Collector接口"><a href="#自己实现Collector接口" class="headerlink" title="自己实现Collector接口"></a>自己实现Collector接口</h2><p>我们自己实现的ToMapCollector类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"><span class="keyword">import</span> java.util.function.*;</div><div class="line"><span class="keyword">import</span> java.util.stream.Collector;</div><div class="line"></div><div class="line"><span class="comment">/**</div><div class="line"> * Created by lichaofan on 2018/5/27.</div><div class="line"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToMapCollector</span>&lt;<span class="title">T</span>, <span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Collector</span>&lt;<span class="title">T</span>, <span class="title">Map</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;, <span class="title">Map</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//获取key</span></div><div class="line">    <span class="keyword">private</span> Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper;</div><div class="line"></div><div class="line">    <span class="comment">//获取value</span></div><div class="line">    <span class="keyword">private</span> Function&lt;? <span class="keyword">super</span> T, ? extends V&gt; valueMapper;</div><div class="line"></div><div class="line">    <span class="comment">//处理key重复时的函数</span></div><div class="line">    <span class="keyword">private</span> BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToMapCollector</span><span class="params">(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</div><div class="line">                               Function&lt;? <span class="keyword">super</span> T, ? extends V&gt; valueMapper,</div><div class="line">                               BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; mergeFunction)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.keyMapper = keyMapper;</div><div class="line">        <span class="keyword">this</span>.valueMapper = valueMapper;</div><div class="line">        <span class="keyword">this</span>.remappingFunction = mergeFunction;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</div><div class="line">     * A function that creates and returns a new mutable result container.</div><div class="line">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Supplier&lt;Map&lt;K, V&gt;&gt; supplier() &#123;</div><div class="line">        <span class="keyword">return</span> HashMap::<span class="keyword">new</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</div><div class="line">     * A function that folds a value into a mutable result container.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a function which folds a value into a mutable result container</div><div class="line">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> BiConsumer&lt;Map&lt;K, V&gt;, T&gt; accumulator() &#123;</div><div class="line">        <span class="keyword">return</span> (map, element) -&gt; &#123;</div><div class="line">            K key = keyMapper.apply(element);</div><div class="line">            V value = valueMapper.apply(element);</div><div class="line">            V oldValue = map.get(key);</div><div class="line">            <span class="comment">//对于重复的key做处理</span></div><div class="line">            V newValue = (oldValue == <span class="keyword">null</span>) ? value :</div><div class="line">                    remappingFunction.apply(oldValue, value);</div><div class="line">            map.put(key, newValue);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</div><div class="line">     * A function that accepts two partial results and merges them.  The</div><div class="line">     * combiner function may fold state from one argument into the other and</div><div class="line">     * return that, or may return a new result container.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a function which combines two partial results into a combined</div><div class="line">     * result</div><div class="line">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> BinaryOperator&lt;Map&lt;K, V&gt;&gt; combiner() &#123;</div><div class="line"></div><div class="line">        <span class="comment">//同样对于重复的key做处理</span></div><div class="line">        <span class="keyword">return</span> (m1, m2) -&gt; &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;K,V&gt; e : m2.entrySet())&#123;</div><div class="line">                V m1Value = m1.get(e.getKey());</div><div class="line">                V m2Value = e.getValue();</div><div class="line">                V newValue = (m1Value == <span class="keyword">null</span>) ? m2Value :</div><div class="line">                        remappingFunction.apply(m1Value, m2Value);</div><div class="line">                m1.put(e.getKey(), newValue);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> m1;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</div><div class="line">     * Perform the final transformation from the intermediate accumulation type</div><div class="line">     * &#123;<span class="doctag">@code</span> A&#125; to the final result type &#123;<span class="doctag">@code</span> R&#125;.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;p&gt;If the characteristic &#123;<span class="doctag">@code</span> IDENTITY_TRANSFORM&#125; is</div><div class="line">     * set, this function may be presumed to be an identity transform with an</div><div class="line">     * unchecked cast from &#123;<span class="doctag">@code</span> A&#125; to &#123;<span class="doctag">@code</span> R&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a function which transforms the intermediate result to the final</div><div class="line">     * result</div><div class="line">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Function&lt;Map&lt;K, V&gt;, Map&lt;K, V&gt;&gt; finisher() &#123;</div><div class="line">        <span class="keyword">return</span> map -&gt; map;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</div><div class="line">     * Returns a &#123;<span class="doctag">@code</span> Set&#125; of &#123;<span class="doctag">@code</span> Collector.Characteristics&#125; indicating</div><div class="line">     * the characteristics of this Collector.  This set should be immutable.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> an immutable set of collector characteristics</div><div class="line">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Characteristics&gt; <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.unmodifiableSet(EnumSet.of(Collector.Characteristics.IDENTITY_FINISH));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用下面的例子验证ToMapCollector ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">List&lt;Member&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</div><div class="line">Member member1 = <span class="keyword">new</span> Member();</div><div class="line">member1.setName(<span class="string">"lichaofan"</span>);</div><div class="line">member1.setId(<span class="number">1</span>);</div><div class="line">member1.setType(<span class="number">1</span>);</div><div class="line">members.add(member1);</div><div class="line"></div><div class="line"><span class="comment">//member2的name是null</span></div><div class="line">Member member2 = <span class="keyword">new</span> Member();</div><div class="line">member2.setName(<span class="keyword">null</span>);</div><div class="line">member2.setId(<span class="number">2</span>);</div><div class="line">member2.setType(<span class="number">2</span>);</div><div class="line">members.add(member2);</div><div class="line"></div><div class="line"><span class="comment">//member3的key和member1的key相同</span></div><div class="line">Member member3 = <span class="keyword">new</span> Member();</div><div class="line">member3.setName(<span class="string">"love wanghongli"</span>);</div><div class="line">member3.setId(<span class="number">1</span>);</div><div class="line">member3.setType(<span class="number">3</span>);</div><div class="line">members.add(member3);</div><div class="line"></div><div class="line"><span class="comment">//keyMapper= Member::getId， valueMapper=Member::getName 当key重复时 value相加</span></div><div class="line">Map&lt;Long, String&gt; nameMap = members.stream().collect(<span class="keyword">new</span> ToMapCollector&lt;&gt;(Member::getId, Member::getName, (oldValue, newValue) -&gt; oldValue + <span class="string">" "</span> + newValue));</div><div class="line"></div><div class="line">System.out.println(nameMap);</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="number">1</span>=lichaofan love wanghongli, <span class="number">2</span>=<span class="keyword">null</span>&#125;</div></pre></td></tr></table></figure>
<p>可以看到，value为null以及key重复时都正常处理了。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/27/Collector接口/" rel="next" title="Collector接口">
                <i class="fa fa-chevron-left"></i> Collector接口
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/27/java8的几个主要函数接口/" rel="prev" title="java8的几个主要函数接口">
                java8的几个主要函数接口 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/lufei.jpg"
               alt="marc" />
          <p class="site-author-name" itemprop="name">marc</p>
           
              <p class="site-description motion-element" itemprop="description">Keep on going</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/amazingmarc" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://tech.meituan.com/" title="美团技术博客" target="_blank">美团技术博客</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Collectors-toMap源码"><span class="nav-number">1.</span> <span class="nav-text">1 Collectors.toMap源码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-关于-“Duplicate-key”"><span class="nav-number">2.</span> <span class="nav-text">2 关于 “Duplicate key”</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-关于-value可能为null的情况"><span class="nav-number">3.</span> <span class="nav-text">3 关于 value可能为null的情况</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#传统的for循环或者forEach"><span class="nav-number">3.1.</span> <span class="nav-text">传统的for循环或者forEach</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用collector的重载方法，自定义supplier-accumulator-和combiner"><span class="nav-number">3.2.</span> <span class="nav-text">使用collector的重载方法，自定义supplier, accumulator,和combiner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自己实现Collector接口"><span class="nav-number">3.3.</span> <span class="nav-text">自己实现Collector接口</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">marc</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
